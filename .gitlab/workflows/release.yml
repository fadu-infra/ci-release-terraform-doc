include:
  # - component: $CI_SERVER_FQDN/tech/components/semantic-release/gitlab-ci-semrel@3.11.5
  - local: 'ci/rules.gitlab-ci.yml'

# semantic-release:
#   stage: release
#   extends:
#     - .semrel-base
#     - .rules:default_skip_docs
#   variables:
#     GITLAB_TOKEN: $GITLAB_API_TOKEN
#     GIT_AUTHOR_EMAIL: 'gitlab-bot@fadutec.com'
#     GIT_COMMITTER_EMAIL: 'gitlab-bot@fadutec.com'
#   script:
#     - semantic-release ${TRACE:+--debug} --ci

release:
  stage: release
  image: node:20-buster-slim
  extends: .rules:default_skip_docs
  variables:
    GITLAB_TOKEN: $GITLAB_API_TOKEN
    GIT_AUTHOR_EMAIL: 'gitlab-bot@fadutec.com'
    GIT_COMMITTER_EMAIL: 'gitlab-bot@fadutec.com'
  before_script:
    - apt-get update && apt-get install -y git
    - npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/gitlab conventional-changelog-conventionalcommits
  script:
    - semantic-release ${TRACE:+--debug} --ci

github-release:
  stage: post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  extends: .rules:default_skip_docs
  variables:
    GITHUB_REPO: 'fadu-infra/ci-release-terraform-doc'
    GITHUB_API_URL: 'https://api.github.com'
  script:
    - |
      # Fetch latest tag
      LATEST_TAG="$(curl -s --fail --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/repository/tags" | jq -r '.[0].name')"
      if [ -z "$LATEST_TAG" ]; then
        echo "Error: Could not fetch latest tag"
        exit 1
      fi
      echo "LATEST_TAG: $LATEST_TAG"

      # Fetch GitLab release info
      GITLAB_RELEASE="$(curl -s --fail --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${LATEST_TAG}")"
      if [ -z "$GITLAB_RELEASE" ]; then
        echo "Error: Could not fetch GitLab release information"
        exit 1
      fi
      echo "GITLAB_RELEASE: $GITLAB_RELEASE"

      # Extract release notes
      RELEASE_NOTES="$(echo "$GITLAB_RELEASE" | jq -r ".description")"
      if [ -z "$RELEASE_NOTES" ]; then
        echo "Warning: Release notes are empty"
      fi

      echo "RELEASE_NOTES: $RELEASE_NOTES"

      # Check if release exists on GitHub
      RELEASE_INFO="$(curl -s --fail -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${GITHUB_TEST_API_TOKEN}" -H "X-GitHub-Api-Version: 2022-11-28" "${GITHUB_API_URL}/repos/${GITHUB_REPO}/releases/tags/${LATEST_TAG}" || echo "")"
      RELEASE_ID="$(echo "$RELEASE_INFO" | jq -r ".id // empty")"

      echo "RELEASE_ID: $RELEASE_ID"

      #echo "Sync GitLab release ${LATEST_TAG} to GitHub
      if [ -z "$RELEASE_ID" ]; then
        jq -n \
          --arg tag "$LATEST_TAG" \
          --arg name "Release ${LATEST_TAG}" \
          --arg body "$RELEASE_NOTES" \
          '{
            tag_name: $tag,
            name: $name,
            body: $body,
            draft: false,
            prerelease: false
          }' > payload.json

        RESPONSE=$(curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${GITHUB_TEST_API_TOKEN}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          -H "Content-Type: application/json" \
          --data @payload.json \
          --write-out "\nHTTP_STATUS:%{http_code}" \
          "${GITHUB_API_URL}/repos/${GITHUB_REPO}/releases" 2>&1)

        HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d":" -f2)
        BODY=$(echo "$RESPONSE" | sed '$d')

        if [ "$HTTP_STATUS" != "201" ]; then
          echo "Error: Failed to create GitHub release. Status: ${HTTP_STATUS}"
          echo "Response body: ${BODY}"
          exit 1
        fi

        echo "Successfully created GitHub release"

      else
        echo "Updating existing GitHub release for tag ${LATEST_TAG}"
        # Update existing release
        jq -n \
          --arg name "Release ${LATEST_TAG}" \
          --arg body "$RELEASE_NOTES" \
          '{
            name: $name,
            body: $body
          }' > payload.json

        RESPONSE=$(curl -L \
          -X PATCH \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${GITHUB_TEST_API_TOKEN}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          -H "Content-Type: application/json" \
          --data @payload.json \
          --write-out "\nHTTP_STATUS:%{http_code}" \
          "${GITHUB_API_URL}/repos/${GITHUB_REPO}/releases/${RELEASE_ID}" 2>&1)

        HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d":" -f2)
        BODY=$(echo "$RESPONSE" | sed '$d')

        if [ "$HTTP_STATUS" != "200" ]; then
          echo "Error: Failed to update GitHub release. Status: ${HTTP_STATUS}"
          echo "Response body: ${BODY}"
          exit 1
        fi

        echo "Successfully updated GitHub release"
      fi
